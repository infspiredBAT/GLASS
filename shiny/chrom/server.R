require(shiny)
library(sangerseqR)
source("helpers.R")

g_call      <- NULL             #annotated basecall data
g_intens    <- NULL             #intensities file
g_helperdat <- NULL             #helper data used in graphs
g_choices   <- NULL
g_selected  <- NULL
g_selected_zoom_index <- 0
g_chrom <- NULL
g_max_y <- NULL
g_abif  <- NULL

shinyServer(function(input,output,session) {

    get_file <- reactive({
       # if (!is.null(input$select_file)) return(input$select_file$datapath)
        if (!is.null(input$select_file)) return(input$select_file)
        else return(NULL)
    })

    loading_processed_files <- reactive ({
        if(!is.null(get_file())) {
            file <- get_file()$datapath
            file_name <- get_file()$name
            withProgress(message = paste('...',sep=" "), value = 1, {
                # TODO - make sure shiny only allows ab1 files (???)
                #        - otherwise chceck if file has correct format
                g_abif      <- sangerseqR::read.abif(file)
                intens      <- get_intensities(g_abif@data)
                res         <- get_call_data(g_abif@data)
                call        <- res$call
                g_max_y     <<- max(intens)
                res$helperdat$max_x <- nrow(intens)
                g_helperdat <<- res$helperdat
                call.dt     <- data.table(call,key="id")
                g_call      <<- call.dt
#                g_choices   <<- g_call[call != reference & seq_trim != "low_qual" & trace_peak != "NA" & !is.na(gen_coord)]
                g_intens    <<- intens
            })
            return("loaded")
        }
        return("not")
    })

    first_update_chosen_variances <- observe({
      if(loading_processed_files() != "not") {
        #TO DO: more sophisticated rules (might need to take intensities into account)
        g_choices <<- g_call[call != reference & seq_trim != "low_qual" & trace_peak != "NA" & !is.na(gen_coord)]
        
      }
    })

    output$plot <- renderChromatography({
        if(loading_processed_files() != "not") {
            g_helperdat$max_y =  (g_max_y*100)/input$max_y_p
            chromatography(g_intens,g_helperdat,g_call,g_choices)
        }
    })

    output$variance_info <- renderPrint({
        if(loading_processed_files() != "not") {
            if(input$choose_variance != "") {
                tryCatch({
                    cat(g_call[id == as.integer(input$choose_variance),paste("",call," -> ",get("reference")," on ",get("exon_intron")," at ",gen_coord," with quality ",quality,sep="")])
                }, error = function(er){
                    if(grepl("NAs introduced",er)) cat("type an integer number")
    #                else cat("Some error")
                })
            } else cat("")
        } else cat("load .abi/.ab1 file")
    })



    update_chosen_variances <- observe({
        input$execute_btn
        isolate({
            if(loading_processed_files() != "not") {
                if(is.null(g_choices))
                    g_choices <<- g_call[as.integer(input$choose_variance)]
                else {
                    if(!as.integer(input$choose_variance) %in% g_choices$id) {
                        new_variance <- g_call[as.integer(input$choose_variance)]
                        new_variance$call <- input$change_peak
                        g_choices <<- rbind(g_choices,new_variance)
                    } else if(g_choices[id == as.integer(input$choose_variance)]$call != input$change_peak)
                        g_choices[id == as.integer(input$choose_variance)]$call <<- input$change_peak
                }
            }
        })
    })

#    output$chosenCheckboxes <- reactive({
#        return(loading_processed_files() != "not" & !is.null(g_choices))
#    })
#    outputOptions(output, "chosenCheckboxes", suspendWhenHidden = F)

#     output$table2 <- DT::renderDataTable({
#         input$execute_btn
#         input$delete_btn
#         if(loading_processed_files() != "not" & !is.null(g_choices)) {
#             DT::datatable(
#                 g_choices,
#                 rownames = checkboxRows(g_choices), escape = -1,
#                 options = list(dom = 'ti')
#             )
#         }
#     })
#
#
#     variace_selected_2 <- observe({
#         if(loading_processed_files() != "not") {
#             g_selected <<- g_choices[input$table2_selected,id]
#             #cat(input$table2_selected)
#         }
#     })

    add_checkboxes <- reactive({
        input$execute_btn
        input$delete_btn
        checkboxes <- paste0('<input type="checkbox" name="row', g_choices$id, '" value="', g_choices$id, '"',"")
        for(i in 1:nrow(g_choices)) {
            if(g_choices[i]$id %in% g_selected) checkboxes[i] <- paste0(checkboxes[i]," checked>","")
            else checkboxes[i] <- paste0(checkboxes[i],">","")
        }
        return(checkboxes)
    })

    output$chosen_variances_table <- shiny::renderDataTable({
        input$execute_btn       #I removed the isnull choices condition as it sometimes doesn't initialize in time. Once the table is created it is quickly updated once choices are changed
        input$delete_btn        #if(loading_processed_files() != "not" & !is.null(g_choices) 
        if(loading_processed_files() != "not" ) {
#            add_checkbox_buttons <- paste0('<input type="checkbox" name="row', g_choices$id, '" value="', g_choices$id, '">',"")
            #add_edit_buttons <- paste0('<a class="go-edit" href="" data-id="', g_choices$id, '"><i class="fa fa-crosshairs"></i></a>')
            add_edit_buttons <- paste0('<input type="button" class="go-edit" value="edit" name="btn',g_choices$id,'" data-id="',g_choices$id,'"',">")
            add_zoom_buttons <- paste0('<input type="button" class="go-zoom" value="zoom" name="btn',g_choices$id,'" data-id="',g_choices$id,'"',">")
            add_checkbox_buttons <- add_checkboxes()
            cbind(Pick=add_checkbox_buttons, Edit=add_edit_buttons, Zoom=add_zoom_buttons, g_choices)
        }
    }, options = list(orderClasses=c(-1,-2,-3), paging=F, columnDefs=list(list(targets=c(0,1,2), searchable=F, orderable=F, title="")))
    , escape=c(-1,-2,-3)
    , callback =
        "function(table) {
                table.on('change.dt', 'tr td input:checkbox', function() {
                    setTimeout(function () {
                        Shiny.onInputChange('rows', $(this).add('tr td input:checkbox:checked').parent().siblings(':nth-child(4)').map(function() {
                            return $(this).text();
                        }).get())
                    }, 10);
                });
                table.on('click', '.go-edit', function(e) {
                    e.preventDefault();
                    $el = $(this);
                    var id_data = $el.data('id');
                    Shiny.onInputChange('goEdit', {
                        id: id_data
                    });
                });
                table.on('click', '.go-zoom', function(e) {
                    e.preventDefault();
                    $el = $(this);
                    var id_data = $el.data('id');
                    Shiny.onInputChange('goZoom', {
                        id: id_data
                    });
                });
            }"
    )

    output$call_table <- shiny::renderDataTable({
    	if(loading_processed_files() != "not" & !is.null(g_call)) {
    		g_call
    	}
    }, options = list(paging=F, columnDefs=list(list(searchable=F, orderable=F, title="")))
    )

    output$intens_table <- shiny::renderDataTable({
        if(loading_processed_files() != "not" & !is.null(g_intens)) {
            g_intens
        }
    }, options = list(paging=T, columnDefs=list(list(searchable=F, orderable=F, title="")))
    )

    variance_select <- observe({
        if(loading_processed_files() != "not") {
            g_selected <<- str_trim(input$rows)
            g_selected_zoom_index <<- 0
#            g_selected_edit_index <<- 0
        }
    })

    goEdit_handler <- observe({
        if(loading_processed_files() != "not") {
            if(is.null(input$goEdit)) return()
            updateTextInput(session,"choose_variance",value=paste0(input$goEdit$id))
        }
    })

    goZoom_handler <- observe({
        if(loading_processed_files() != "not") {
            if(is.null(input$goZoom)) return()
            cat(paste0(input$goZoom$id,","))
            session$sendCustomMessage(type = 'zoom_message',message = paste0(input$goZoom$id))
            print(g_helperdat$helper_intrex$start[1])
            g_helperdat$helper_intrex$start[1]<<-50
            print(g_helperdat$helper_intrex$start[1])

            chromatography(g_intens,g_helperdat)
        }
    })

#     edit_handler <- observe({
#         input$edit_btn
#         isolate({
#             if(length(g_selected) != 0) {
#                 index <- g_selected_zoom_index + 1
#                 g_selected_zoom_index <<- (1 + g_selected_zoom_index) %% length(g_selected)
#                 updateTextInput(session,"choose_variance",value=paste0(g_selected[index]))
#             }
#         })
#     })

#     zoom_handler <- observe({
#         input$zoom_btn
#         isolate({
#             if(length(g_selected) != 0) {
#                 index <- g_selected_zoom_index + 1
#                 g_selected_zoom_index <<- (1 + g_selected_zoom_index) %% length(g_selected)
#                 cat(paste0(g_selected[index],","))
#                 session$sendCustomMessage(type = 'zoom_message',message = paste0(g_selected[index]))
#             }
#         })
#     })

    delete_handler <- observe({
        input$delete_btn
        isolate({
            if(length(g_selected) != 0) {
                g_choices <<- g_choices[-match(g_selected,id)]
                g_selected <<-  NULL
            }
        })
    })
})
